<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="XP_Per_Second"
   author="Fiendish"
   id="1a51060953c22607294a884d"
   language="Lua"
   purpose="Displays calculated XP per second for the last mob fight."
   date_written="2012-02-07 16:46:02"
   requires="4.75"
   version="1.0"
   save_state="y"
   >
</plugin>

<triggers>
<trigger
   enabled="y"
   name="got_xp"
   match="^You receive ([\d+]+)( bonus)? experience points"
   regexp="y"
   omit_from_output="n"
   sequence="100"
   script="new_exp"
>
</trigger>
</triggers>

<script>
<![CDATA[

require "gmcphelper"

function new_exp(name, line, wildcards, styles)
   loadstring("val = "..wildcards[1])()
   xp_total = xp_total+val
end

xp_total = 0
previous_state = "0"
start_time = 0

function OnPluginBroadcast(msg, id, name, text)
   -- Look for GMCP handler.
   if (id == '3e7dedbe37e44942dd46d264') then
      if text == "char.status" then -- only watch for char.status.state change
         res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status") -- get the char.status values
         luastmt = "gmcpdata = " .. gmcparg --- Convert the serialized string back into a lua table.

         assert (loadstring (luastmt or "")) ()

         state = gmcpdata.state
         if previous_state == "8" and state ~= "8" then
            print("Last fight I got "..string.format("%.1f",xp_total/(utils.timer()-start_time)).." xp/sec.")
            xp_total = 0
            previous_state = state
            EnableTrigger("got_xp",false)
         elseif previous_state ~= "8" and state == "8" then
            start_time = utils.timer()
            EnableTrigger("got_xp",true)
            previous_state = state
         end
      end
   end
end -- onpluginbroadcast

]]>
</script>
</muclient>
