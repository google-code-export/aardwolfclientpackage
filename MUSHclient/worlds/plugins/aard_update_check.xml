<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Aardwolf_Package_Update_Checker"
   author="Fiendish"
   id="162bba4a5ecef2bb32b5652f"
   language="Lua"
   purpose="Checks online for newer versions of the Aardwolf MUSHclient Package."
   date_written="2011-04-23 11:51:55"
   requires="4.72"
   version="1.0"
   >

</plugin>
<!--  Script  -->

<aliases>
  <alias
   match="package update check"
   enabled="y"
   sequence="100"
   omit_from_output="y"
   ignore_case="y"
   script="OnPluginInstall"
  >
  </alias>
  </aliases>
  
<script>
<![CDATA[

http = require "socket.http"	-- loads http and various dlls
download_url = "https://code.google.com/p/aardwolfclientpackage/downloads/detail?name=MUSHclient.zip"
window_title = "Aardwolf MUSHclient Package Update Checker"

function convertHTMLcodesToStandardText(str)
    if not str then
        return nil
    end
    
    local replacements = { -- minimal set. can add more later if needed.
    {"&gt;",">"},
    {"&lt;","<"},
    {"&quot;","\""},
    {"&#39;","'"},
    {"&amp;","&"}
    }
    for i,v in ipairs(replacements) do
        str = string.gsub(str, v[1],v[2])
    end
    return str
end

function updateDialog()
    if utils.editbox("There's a new Aardwolf MUSHclient Package development snapshot available. You currently have version r"..(local_version or "<ERROR!>").." and the newest version is r"..(latest_version or "<ERROR!>")..".\nThe major differences between your version and the latest version are:",window_title,convertHTMLcodesToStandardText(final_update_list) or "<ERROR!>",nil,nil,{ok_button="Ok, Show Me", cancel_button="Maybe Later"}) then
        OpenBrowser(download_url)
    end
end

function errorMessage(msg)
   utils.inputbox(msg,"ERROR: "..window_title,download_url,nil,nil,{ok_button="Oops", cancel_button="Oh no"})
end

function OnPluginInstall()
    -- open the local version file and read the snapshot revision on the third line
    version_file = io.input ("AardwolfPackageChanges.txt")
    line = version_file:read ("*l") -- read one line
    line = version_file:read ("*l") -- read one line
    line = version_file:read ("*l") -- read one line
    if line then  -- if we got something
       local_version = string.match(line, "r(%d+) snapshot")
    else
       DoAfterSpecial(10,'errorMessage("The file AardwolfPackageChanges.txt appears to be missing (this is bad), so the version check cannot proceed. You may download the latest development snapshot from:")', sendto.script)
       return
    end
    version_file:close ()
    
    -- grab the download page
    page, status, headers = http.request(download_url)
    if status == 200 then
        update_list = string.match(page, "Aardwolf Client Package Major Changes List\r\n\r\n(r%d+ snapshot.*)")
        -- extract the snapshot revision number
        latest_version = string.match(update_list, "r(%d+) snapshot")
    else
        DoAfterSpecial(10,'errorMessage("Could not access the Aardwolf MUSHclient Package download page to check for the latest version number. Please make sure that you are able to access the following url in your browser and then type \'PACKAGE UPDATE CHECK\' to try again...")', sendto.script)
        return
    end
    
    if tonumber(local_version) and tonumber(latest_version) then
        if tonumber(local_version) < tonumber(latest_version) then
            final_update_list = (string.match(update_list,"(.*)r"..local_version.." snapshot") or "<ERROR! Please don't modify your AardwolfPackageChanges.txt file>\r\n").."\r\nGet it from: "..download_url
             -- FYI: a bug causes MUSHclient 4.72 to crash if utils.editbox is used immediately after a call to Connect()
            DoAfterSpecial (10, 'updateDialog()', sendto.script)
        elseif tonumber(local_version) > tonumber(latest_version) then
            DoAfterSpecial(10,'errorMessage("Oh, dear...this is embarrassing. The Aardwolf MUSHclient Package update checker has detected that you have a version NEWER than what is available online! Go to the following url in your browser to get the latest package and contact Fiendish about this message, because clearly this situation is impossible. :/")', sendto.script)
        end
    end
end

]]>

</script>
</muclient>
